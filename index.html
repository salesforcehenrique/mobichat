<script type='text/javascript'>
    // Variáveis de contexto do usuário logado (simulação)
    var NomeUsuarioLogado = "Igor Nogueira Silva";
    var CPFLogado = "085.094.706-50";
    var NomeConta = "Ita Corretora";
    var CodigoUsuario = "U-16010";
    var CodigoConta = "C-9";

    var initESW = function(gslcSettings) {
        embedded_svc.settings.displayHelpButton = true; // Exibe o botão de ajuda (chat)
        embedded_svc.settings.language = ''; // Deixe vazio para usar o idioma do navegador

        // Configuração de dados de pré-chat
        embedded_svc.settings.prechatDetails = [
            // {label:"NomeUsuario", value: NomeUsuarioLogado, displayToAgent:true}, // Se você quiser que o agente veja o nome
            // {label:"CPF", value: CPFLogado, displayToAgent:true}, // Se você quiser que o agente veja o CPF
            {label:"NomeConta", value: NomeConta, displayToAgent:false},
            {label:"CodigoUsuario", value: CodigoUsuario, displayToAgent:false},
            {label:"CodigoConta", value: CodigoConta, displayToAgent:false}
        ];

        // Configuração de dados de pré-chat para o Flow (usando setCustomSalesforceChatData)
        // O seu XML sugere que você está usando esta abordagem, que é a mais moderna e recomendada.
        embedded_svc.settings.extraPrechatInfo = [
            {
                "entityName": "Contact",
                "saveToTranscript": "NomeUsuario",
                "entityFieldMaps": [
                    {"fieldName": "FirstName", "doFind": false, "is
                    exactMatch": false, "doCreate": true, "
                    "label": "NomeUsuario"}
                ]
            },
            // Adicione outras entidades e campos conforme a sua necessidade de busca e criação de registros
        ];

        // Envio de dados customizados para o Flow (Variáveis de Entrada)
        // Estes são os dados que o seu Flow (embeddedServiceChatEnhanced) irá receber como variáveis de entrada.
        embedded_svc.settings.extraPrechatInfo = [
            {
                "entityName": "Case", // Entidade que será criada ou associada
                "saveToTranscript": "NomeUsuario",
                "entityFieldMaps": [
                    {"fieldName": "Subject", "doFind": false, "isExactMatch": false, "doCreate": true, "label": "NomeUsuario"}
                ]
            }
        ];

        // **A forma mais direta para o Flow é usar o prechatDetails e mapear no Flow:**
        embedded_svc.settings.prechatDetails = [
            {label:"NomeUsuario", value: NomeUsuarioLogado, displayToAgent:false},
            {label:"CPF", value: CPFLogado, displayToAgent:false},
            {label:"NomeConta", value: NomeConta, displayToAgent:false},
            {label:"CodigoUsuario", value: CodigoUsuario, displayToAgent:false},
            {label:"CodigoConta", value: CodigoConta, displayToAgent:false}
        ];
        
        // **OU, se você estiver usando a abordagem de setCustomSalesforceChatData no seu Flow:**
        // Você deve garantir que a função seja chamada após o carregamento do Live Agent.
        embedded_svc.addEventHandler("onChatEstablished", function(event) {
            embedded_svc.liveagentAPI.setCustomSalesforceChatData([
                {
                    "name": "NomeUsuario",
                    "value": NomeUsuarioLogado
                },
                {
                    "name": "CPF",
                    "value": CPFLogado
                },
                {
                    "name": "NomeConta",
                    "value": NomeConta
                },
                {
                    "name": "CodigoUsuario",
                    "value": CodigoUsuario
                },
                {
                    "name": "CodigoConta",
                    "value": CodigoConta
                }
            ]);
        });

        // O restante do seu código de inicialização do Embedded Service Chat...
        embedded_svc.init(
            'https://[SEU_DOMINIO].my.salesforce.com',
            'https://[SEU_DOMINIO].my.salesforce-sites.com/liveagent',
            gslcSettings.baseLiveAgentContentURL,
            '[ORG_ID]',
            '[DEPLOYMENT_ID]',
            {
                baseLiveAgentContentURL: gslcSettings.baseLiveAgentContentURL,
                deploymentId: gslcSettings.deploymentId,
                buttonId: gslcSettings.buttonId,
                baseLiveAgentURL: gslcSettings.baseLiveAgentURL,
                eswConfigDevName: gslcSettings.eswConfigDevName,
                isOfflineSupportEnabled: gslcSettings.isOfflineSupportEnabled
            }
         );
    };

    if (!window.embedded_svc) {
        var s = document.createElement('script');
        s.setAttribute('src', 'https://[SEU_DOMINIO].my.salesforce.com/embeddedservice/5.0/esw.min.js' );
        s.onload = function() {
            initESW(null);
        };
        document.body.appendChild(s);
    } else {
        initESW('https://[SEU_DOMINIO].my.salesforce.com' );
    }
</script>
